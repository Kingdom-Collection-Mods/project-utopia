# Based on Made Divided Monarchists by Victoria/Pacifica/AcresOfAsteraceae
# Together with ideologies and hegemon mechanic from EU4 creatin New Dawn journal chapter.
# 
# Refer to comments here and in 02_french_monarchism to get an idea as to how this works.

ut_set_new_dawn_variables = {
	#Communist Variables
	set_variable = { name = ut_nd_communist_progress_from_characters value = 0 } #Progress-from-character component. This updates with the combined popularities of every Communist character later on, and is used to calculate monthly progress in the progress bar.
	set_variable = { name = ut_nd_communist_progress_from_igs value = 0 } #Progress-from-IG component. This updates with the combined clout of every Communist IG later on, and is used to calculate monthly progress in the progress bar.
	set_variable = { name = ut_nd_communist_progress_from_laws value = 0 } #Progress-from-military-building component. This updates with the sum of military building levels in France later on, and is used to calculate monthly progress in the progress bar.
	set_variable = { name = ut_nd_communist_progress_from_legitimacy value = 0 } #Progress-from-legitimacy component. This updates with the current government legitimacy, and is also used to calculate monthly progress in the progress bar.
	set_variable = { name = ut_nd_communist_progress_from_movements value = 0 } #Progress-from-movements component. This depends upon the support of various movements, and is also used to calculate monthly progress in the progress bar.
	set_variable = { name = ut_nd_communist_progress_from_focus value = 0 } #Final element in the progress bar. This is defined by various effects, and is based solely on scripted effects. This is how designers can manually grant ticking bonuses or maluses to this mechanic.
	set_variable = { name = ut_nd_communist_progress_from_events value = 0 }

	#Moderate Variables
	set_variable = { name = ut_nd_democrat_progress_from_characters value = 0 } 
	set_variable = { name = ut_nd_democrat_progress_from_igs value = 0 }
	set_variable = { name = ut_nd_democrat_progress_from_laws value = 0 } #These variables use the same scheme as the Communist ones, with the exception that Moderates derive from the sum of light/heavy industry building levels in France.
	set_variable = { name = ut_nd_democrat_progress_from_legitimacy value = 0 }
	set_variable = { name = ut_nd_democrat_progress_from_movements value = 0 }
	set_variable = { name = ut_nd_democrat_progress_from_focus value = 0 }
	set_variable = { name = ut_nd_democrat_progress_from_events value = 0 }
	
	#Autocrat Variables
	set_variable = { name = ut_nd_autocrat_progress_from_characters value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_igs value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_laws value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_legitimacy value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_movements value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_focus value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_events value = 0 }
	
	#Fascist Variables
	set_variable = { name = ut_nd_fascist_progress_from_characters value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_igs value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_laws value = 0 } #These variables use the same scheme as the Communist ones, with the exception that Fascists derive from the sum of agricultural building levels in France.
	set_variable = { name = ut_nd_fascist_progress_from_legitimacy value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_movements value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_focus value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_events value = 0 }

	set_variable = { name = ig_weight value = 0 } #This variable is used solely for mathematical purposes, and is set as equivalent to the clout of a given interest group. It exists so that IGs can be weighted higher or lower depending on whether they're in-government or not.
}

ut_new_dawn_communist_progress = { #Effects like these are run three times, one for each house. All of them function essentially the same way.
	set_variable = { name = ut_nd_communist_progress_from_characters value = 0 } #All of these variables are ephemeral and should never be manually set to anything.
	set_variable = { name = ut_nd_communist_progress_from_igs value = 0 }
	set_variable = { name = ut_nd_communist_progress_from_laws value = 0 }
	set_variable = { name = ut_nd_communist_progress_from_focus value = 0 }
	set_variable = { name = ut_nd_communist_progress_from_movements value = 0 }
	set_variable = { name = ut_nd_communist_progress_from_legitimacy value = root.government_legitimacy } #Government legitimacy is a single constant, and so this variable is set immediately rather than needing a calculation.
	#From Characters
	every_scope_character = {
		limit = {
			ut_ideology_new_dawn_communist_trigger = yes
		}
		ROOT = {
			change_variable = { name = ut_nd_communist_progress_from_characters add = prev.popularity } #for_each loop. For each character of ideology_Communist, add that character's popularity to ut_nd_communist_progress_from_characters.
		}
	}
	change_variable = { name = ut_nd_communist_progress_from_characters divide = 100 } #Character popularities are -100/100, rather than our desired -1/1, so divide by 100.
	if = {
		limit = {
			var:ut_nd_communist_progress_from_characters > 1
		}
		set_variable = {
			name = ut_nd_communist_progress_from_characters
			value = 1
		}
	}
	else_if = {
		limit = {
			var:ut_nd_communist_progress_from_characters < -1
		}
		set_variable = {
			name = ut_nd_communist_progress_from_characters
			value = -1
		}
	}
	# From Interest Groups
	every_interest_group = {
		limit = {
			leader = {
				ut_ideology_new_dawn_communist_trigger = yes
			}
		}
		ROOT = {														#for_each loop. For each interest group of ideology_Communist, perform the following steps in sequence.
			set_variable = { name = ig_weight value = prev.ig_clout } 	#1. Set ig_weight as equal to the interest group's clout.
		}
		ROOT = {
			change_variable = { name = ut_nd_communist_progress_from_igs add = var:ig_weight }	#3. Add ig_weight to the central ut_nd_communist_progress_from_igs variable. This will run until there are no more Communist IGs.
		}
	}
	# From Laws
	if = {
		limit = {
			OR = {
				has_law = law_type:law_command_economy
				has_law = law_type:law_cooperative_ownership
			}
		}
		change_variable = { name = ut_nd_communist_progress_from_laws add = 1 }
	}
	# From Movements
	# From Legitimacy
	change_variable = { name = ut_nd_communist_progress_from_legitimacy divide = 100 } #Legitimacy divided by 100, to make it minimum 0 and maximum 1.
	change_variable = { name = ut_nd_communist_progress_from_legitimacy subtract = 0.5 } #Legitimacy subtracted by 0.5, to make it minimum -0.5 and maximum 0.5. Balanced scale of negative to absolute value.
	if = {
		limit = {
			ruler = {
				NOT = { ut_ideology_new_dawn_communist_trigger = yes}
			}
		}
		change_variable = { name = ut_nd_communist_progress_from_legitimacy multiply = -0.5 } #If the ruler is not Communist, they benefit from low legitimacy and suffer from high legitimacy.
	}
	if = {
		limit = { 
			has_modifier = je_ut_new_dawn_communist_focus
		}
		change_variable = { name = ut_nd_communist_progress_from_focus add = 0.5 } #If the Cement the Rightful Dynasty focus is active, add 0.5 to the progress bar.
	}
}
 
ut_new_dawn_democrat_progress = { #See Communist progress to see how this works.
	set_variable = { name = ut_nd_democrat_progress_from_characters value = 0 }
	set_variable = { name = ut_nd_democrat_progress_from_igs value = 0 }
	set_variable = { name = ut_nd_democrat_progress_from_laws value = 0 }
	set_variable = { name = ut_nd_democrat_progress_from_movements value = 0 }
	set_variable = { name = ut_nd_democrat_progress_from_focus value = 0 }
	set_variable = { name = ut_nd_democrat_progress_from_legitimacy value = root.government_legitimacy }
	#From Characters
	every_scope_character = {
		limit = {
			ut_ideology_new_dawn_democrat_trigger = yes
		}
		ROOT = {
			change_variable = { name = ut_nd_democrat_progress_from_characters add = prev.popularity }
		}
	}
	change_variable = { name = ut_nd_democrat_progress_from_characters divide = 200 } #x2
	if = {
		limit = {
			var:ut_nd_democrat_progress_from_characters > 1
		}
		set_variable = {
			name = ut_nd_democrat_progress_from_characters
			value = 1
		}
	}
	else_if = {
		limit = {
			var:ut_nd_democrat_progress_from_characters < -1
		}
		set_variable = {
			name = ut_nd_democrat_progress_from_characters
			value = -1
		}
	}
	# From Interest Groups
	every_interest_group = {
		limit = {
			leader = {
				ut_ideology_new_dawn_democrat_trigger = yes
			}
		}
		ROOT = {
			set_variable = { name = ig_weight value = prev.ig_clout }
		}
		ROOT = {
			change_variable = { name = ut_nd_democrat_progress_from_igs add = var:ig_weight }
		}
	}
	# From Laws
	if = {
		limit = {
			has_law = law_type:law_universal_suffrage
		}
		ROOT = {
			change_variable = { name = ut_nd_democrat_progress_from_laws add = 1 }
		}
	}
	
	if = {
		limit = {
			has_law = law_type:law_census_voting
		}
		ROOT = {
			change_variable = { name = ut_nd_democrat_progress_from_laws add = 0.5 }
		}
	}
	# From Movements
	# From Legitimacy
	change_variable = { name = ut_nd_democrat_progress_from_legitimacy divide = 100 }
	change_variable = { name = ut_nd_democrat_progress_from_legitimacy subtract = 0.5 }
	if = {
		limit = {
			ruler = {
				NOT = { ut_ideology_new_dawn_democrat_trigger = yes }
			}
		}
		change_variable = { name = ut_nd_democrat_progress_from_legitimacy multiply = -0.5 }
	}
	if = {
		limit = { 
			has_modifier = je_ut_new_dawn_democrat_focus
		}
		change_variable = { name = ut_nd_democrat_progress_from_focus add = 0.5 } #If the Cement the Rightful Dynasty focus is active, add 0.5 to the progress bar.
	}
}


ut_new_dawn_autocrat_progress = { #See Communist progress to see how this works.
	set_variable = { name = ut_nd_autocrat_progress_from_base value = 0.5 }
	set_variable = { name = ut_nd_autocrat_progress_from_characters value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_igs value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_laws value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_movements value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_focus value = 0 }
	set_variable = { name = ut_nd_autocrat_progress_from_legitimacy value = root.government_legitimacy }
	set_variable = { name = ut_nd_autocrat_progress_from_events value = 0 }
	#From Characters
	every_scope_character = {
		limit = {
			ut_ideology_new_dawn_autocrat_trigger = yes
		}
		ROOT = {
			change_variable = { name = ut_nd_autocrat_progress_from_characters add = prev.popularity }
		}
	}
	change_variable = { name = ut_nd_autocrat_progress_from_characters divide = 200 } #x2
	if = {
		limit = {
			var:ut_nd_autocrat_progress_from_characters > 1
		}
		set_variable = {
			name = ut_nd_autocrat_progress_from_characters
			value = 1
		}
	}
	else_if = {
		limit = {
			var:ut_nd_autocrat_progress_from_characters < -1
		}
		set_variable = {
			name = ut_nd_autocrat_progress_from_characters
			value = -1
		}
	}
	# From Interest Groups
	every_interest_group = {
		limit = {
			leader = {
				ut_ideology_new_dawn_autocrat_trigger = yes
			}
		}
		ROOT = {
			set_variable = { name = ig_weight value = prev.ig_clout }
		}
		ROOT = {
			change_variable = { name = ut_nd_autocrat_progress_from_igs add = var:ig_weight }
		}
	}
	# From Laws
	if = {
		limit = {
			OR = {
				has_law = law_type:law_monarchy
				has_law = law_type:law_autocracy
			}
			NOT = { has_law = law_type:law_universal_suffrage }
		}
		ROOT = {
			change_variable = { name = ut_nd_autocrat_progress_from_laws add = 1 }
		}
	}
	# From Movements
	# From Legitimacy
	change_variable = { name = ut_nd_autocrat_progress_from_legitimacy divide = 100 }
	change_variable = { name = ut_nd_autocrat_progress_from_legitimacy subtract = 0.5 }
	if = {
		limit = {
			ruler = {
				NOT = { ut_ideology_new_dawn_autocrat_trigger = yes }
			}
		}
		change_variable = { name = ut_nd_autocrat_progress_from_legitimacy multiply = -0.5 }
	}
	if = {
		limit = { 
			has_modifier = je_ut_new_dawn_autocrat_focus
		}
		change_variable = { name = ut_nd_autocrat_progress_from_focus add = 0.5 } #If the Cement the Rightful Dynasty focus is active, add 0.5 to the progress bar.
	}
	if = {
		limit = { 
			has_modifier = je_ut_new_dawn_strengthen_power_mod
		}
		change_variable = {
			name = ut_nd_autocrat_progress_from_events
			add = 0.5 
		}
	}
}

ut_new_dawn_fascist_progress = { #See Fascist progress to see how this works.
	set_variable = { name = ut_nd_fascist_progress_from_characters value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_igs value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_laws value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_movements value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_focus value = 0 }
	set_variable = { name = ut_nd_fascist_progress_from_legitimacy value = root.government_legitimacy }
	set_variable = { name = ut_nd_fascist_progress_from_events value = 0 }
	#From Characters
	every_scope_character = {
		limit = {
			ut_ideology_new_dawn_fascist_trigger = yes
		}
		ROOT = {
			change_variable = { name = ut_nd_fascist_progress_from_characters add = prev.popularity }
		}
	}
	change_variable = { name = ut_nd_fascist_progress_from_characters divide = 100 }
	if = {
		limit = {
			var:ut_nd_fascist_progress_from_characters > 1
		}
		set_variable = {
			name = ut_nd_fascist_progress_from_characters
			value = 1
		}
	}
	else_if = {
		limit = {
			var:ut_nd_fascist_progress_from_characters < -1
		}
		set_variable = {
			name = ut_nd_fascist_progress_from_characters
			value = -1
		}
	}
	# From Interest Groups
	every_interest_group = {
		limit = {
			leader = {
				ut_ideology_new_dawn_fascist_trigger = yes
			}
		}
		ROOT = {
			set_variable = { name = ig_weight value = prev.ig_clout }
		}
		ROOT = {
			change_variable = { name = ut_nd_fascist_progress_from_igs add = var:ig_weight }
		}
	}
	# From Buildings
	if = {
		limit = {
			has_law = law_type:law_ethnostate
			has_law = law_type:law_neo_ethno_state
		}
		change_variable = { name = ut_nd_fascist_progress_from_laws add = 1 }
	}
	# From Movements
	if = {
		limit = {
			any_political_movement = {
				is_political_movement_type = movement_fascist
			}
		}
		random_political_movement = {
			limit = {
				is_political_movement_type = movement_fascist
			}
			ROOT = {
				set_variable = { name = ut_nd_fascist_progress_from_movements value = prev.political_movement_support }
				change_variable = { name = ut_nd_fascist_progress_from_movements multiply = 10 }
			}
		}
	}
	# From Legitimacy
	change_variable = { name = ut_nd_fascist_progress_from_legitimacy divide = 100 }
	change_variable = { name = ut_nd_fascist_progress_from_legitimacy subtract = 0.5 }
	if = {
		limit = {
			ruler = {
				NOT = { ut_ideology_new_dawn_fascist_trigger = yes }
			}
		}
		change_variable = { name = ut_nd_fascist_progress_from_legitimacy multiply = -0.5 }
	}
	if = {
		limit = { 
			has_modifier = je_ut_new_dawn_fascist_focus
		}
		change_variable = { name = ut_nd_fascist_progress_from_focus add = 0.5 } #If the Cement the Rightful Dynasty focus is active, add 0.5 to the progress bar.
	}
}

ut_clear_divided_new_dawn_variables = { #Clears all variables, to save memory/performance. Should be executed by anything that makes Divided Monarchists irrelevant.
	remove_variable = ut_nd_communist_progress_from_characters 
	remove_variable = ut_nd_communist_progress_from_igs 
	remove_variable = ut_nd_communist_progress_from_laws 
	remove_variable = ut_nd_communist_progress_from_legitimacy 
	remove_variable = ut_nd_communist_progress_from_movements 
	remove_variable = ut_nd_communist_progress_from_focus
	remove_variable = ut_nd_communist_progress_from_events

	remove_variable = ut_nd_democrat_progress_from_characters 
	remove_variable = ut_nd_democrat_progress_from_igs 
	remove_variable = ut_nd_democrat_progress_from_laws 
	remove_variable = ut_nd_democrat_progress_from_legitimacy 
	remove_variable = ut_nd_democrat_progress_from_movements 
	remove_variable = ut_nd_democrat_progress_from_focus 
	remove_variable = ut_nd_democrat_progress_from_events

	remove_variable = ut_nd_autocrat_progress_from_characters 
	remove_variable = ut_nd_autocrat_progress_from_igs
	remove_variable = ut_nd_autocrat_progress_from_laws
	remove_variable = ut_nd_autocrat_progress_from_legitimacy
	remove_variable = ut_nd_autocrat_progress_from_movements
	remove_variable = ut_nd_autocrat_progress_from_focus
	remove_variable = ut_nd_autocrat_progress_from_events

	remove_variable = ut_nd_fascist_progress_from_characters 
	remove_variable = ut_nd_fascist_progress_from_igs 
	remove_variable = ut_nd_fascist_progress_from_laws 
	remove_variable = ut_nd_fascist_progress_from_legitimacy 
	remove_variable = ut_nd_fascist_progress_from_movements 
	remove_variable = ut_nd_fascist_progress_from_focus 
	remove_variable = ut_nd_fascist_progress_from_events

	remove_variable = ig_weight 
}

ut_freeze_new_dawn_progress = { #Used upon initiation of cement_the_rightful_dynasty, to prevent the bars from excessively accumulating.
	set_variable = ut_new_dawn_bar_freeze
}