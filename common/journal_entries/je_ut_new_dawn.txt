je_ut_new_dawn = {
	icon = "gfx/interface/icons/event_icons/event_protest.dds"

	group = je_group_utopia
	

	is_shown_when_inactive = {
		is_player = yes
		has_technology_researched = mass_propaganda
	}

	possible = {
		pop_type_percent_country = {
			pop_type = service_workers
			percent > 0.05
		}
	}

	modifiers_while_active = {
		new_dawn_ongoing
	}

	immediate = {
		ut_set_new_dawn_variables = yes
		# random_law = {
		# 	limit = { type = law_type:law_monarchy }
		# 	save_scope_as = monarchy_scope
		# }
	}

	scripted_progress_bar = ut_new_dawn_fascist_bar
	scripted_progress_bar = ut_new_dawn_moderate_bar
	scripted_progress_bar = ut_new_dawn_communist_bar

	complete = {
		custom_tooltip = {
			text = je_ut_new_dawn_condition_tt
			has_variable = je_ut_new_dawn_done #Can only ever complete upon finishing the Cement the Rightful Dynasty journal entry.
		}
	}

	on_complete = {
		custom_tooltip = {
			text = je_ut_new_dawn_effect_tt
			ut_clear_divided_new_dawn_variables = yes #Removes all variables used for math in this JE, to save memory and performance.
		}
	}

	status_desc = {
		first_valid = {
			triggered_desc = { # Cementing the Rightful Dynasty is active
				desc = ut_new_dawn_moderate_status
				trigger = {
					has_journal_entry = je_cement_the_rightful_dynasty
				}
			}
			triggered_desc = { # In the lead and on the throne
				desc = ut_new_dawn_fascist_status
				trigger = {
					AND = {
						scope:journal_entry = { 
							"scripted_bar_progress(ut_new_dawn_fascist_bar)" > "scripted_bar_progress(ut_new_dawn_communist_bar)"
							"scripted_bar_progress(ut_new_dawn_fascist_bar)" > "scripted_bar_progress(ut_new_dawn_moderate_bar)" 
						}
					}
				}
			}
			triggered_desc = {
				desc = ut_new_dawn_communist_status
				trigger = {
					scope:journal_entry = { 
						"scripted_bar_progress(ut_new_dawn_communist_bar)" > "scripted_bar_progress(ut_new_dawn_fascist_bar)"
						"scripted_bar_progress(ut_new_dawn_communist_bar)" > "scripted_bar_progress(ut_new_dawn_moderate_bar)" 
					}
				}
			}
		}
	}

	on_weekly_pulse = {
		events = {
			event_new_dawn.1
		}
		effect = {
			if = {
				limit = {
					NOT = {
						has_variable = fra_divided_monarchists_freeze #This variable stops iteration, and is granted by reaching 480 with one dynasty. It's reset when this JE is completed, or when je_cement_the_rightful_dynasty fails.
					}
				}
				ut_new_dawn_fascist_progress = yes #Calculates how much the Legitimists will get next month. Updates weekly, but is not added until the monthly.
				ut_new_dawn_moderate_progress = yes  #Calculates how much the Orleanists will get next month. Updates weekly, but is not added until the monthly.
				ut_new_dawn_communist_progress = yes  #Calculates how much the Bonapartists will get next month. Updates weekly, but is not added until the monthly.
			}
		}
	}

	on_monthly_pulse = {
		effect = {
			if = {
				limit = {
					has_law = law_type:law_monarchy
					scope:journal_entry = { 
						OR = {
							"scripted_bar_progress(ut_new_dawn_fascist_bar)" >= divided_monarchists_upper_bound
							"scripted_bar_progress(ut_new_dawn_moderate_bar)" >= divided_monarchists_upper_bound
							"scripted_bar_progress(ut_new_dawn_communist_bar)" >= divided_monarchists_upper_bound
						}
					}
					NOT = {
						has_variable = fra_divided_monarchists_freeze
					}
				}
				if = { #Fires the event to enthrone the pretender - 1 if contextualised as coup, 10 if contextualised as reinforcement.
					limit = {
						scope:journal_entry = { 
							"scripted_bar_progress(ut_new_dawn_communist_bar)" > "scripted_bar_progress(ut_new_dawn_moderate_bar)"
							"scripted_bar_progress(ut_new_dawn_communist_bar)" > "scripted_bar_progress(ut_new_dawn_fascist_bar)" 
						}
					}
					if = {
						limit = {
							ruler_is_bonapartist = yes
						}
						trigger_event = { id = event_new_dawn.2 popup = yes} #Reinforcement event - fires if the leading dynasty is the one in power.
					}
					else = {
						trigger_event = { id = event_new_dawn.3 popup = yes} #Coup event - fires if the leading dynasty is not the one in power.
					}
				}
				else_if = {
					limit = {
						scope:journal_entry = { 
							"scripted_bar_progress(ut_new_dawn_fascist_bar)" > "scripted_bar_progress(ut_new_dawn_moderate_bar)"
							"scripted_bar_progress(ut_new_dawn_fascist_bar)" > "scripted_bar_progress(ut_new_dawn_communist_bar)" 
						}
					}
					if = {
						limit = {
							ruler_is_orleanist = yes
						}
						trigger_event = { id = event_new_dawn.2 popup = yes}
					}
					else = {
						trigger_event = { id = event_new_dawn.3 popup = yes}
					}
				}
				else_if = {
					limit = {
						scope:journal_entry = { 
							"scripted_bar_progress(ut_new_dawn_moderate_bar)" > "scripted_bar_progress(ut_new_dawn_communist_bar)"
							"scripted_bar_progress(ut_new_dawn_moderate_bar)" > "scripted_bar_progress(ut_new_dawn_fascist_bar)" 
						}
					}
					if = {
						limit = {
							ruler_is_legitimist = yes
						}
						trigger_event = { id = event_new_dawn.2 popup = yes}
					}
					else = {
						trigger_event = { id = event_new_dawn.3 popup = yes}
					}
				}
				ut_freeze_new_dawn_progress = yes #Freezes the bars so that they no longer accumulate progress on the monthly tick, and stay as they are. In the case that Cement the Rightful Dynasty fails, the bars will be set back.
			}
		}
		random_events = {
			400 = 0
			# 10 = french_pretenders_pulse.2
			# 10 = french_pretenders_pulse.3
			# 50 = french_pretenders_pulse.10
			# 10 = french_pretenders_pulse.11
			# 10 = french_pretenders_pulse.12
			# 10 = french_pretenders_pulse.13
			# 10 = french_pretenders_pulse.14
			# 10 = french_pretenders_pulse.15
			# 10 = french_pretenders_pulse.16
			# 10 = french_pretenders_pulse.17
			# 10 = french_pretenders_pulse.18
		}
	}

	weight = 100

	should_be_pinned_by_default = yes
}